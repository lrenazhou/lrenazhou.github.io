<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Datadog take-home assignment | lrenazhou</title>
  <meta name="description" content="Lucy Zhou is a writer based in the Bay Area. Her writing has appeared in Nat. Brut, The Offing, X-R-A-Y Literary Magazine, and has been nominated for a Pushchart Prize. In 2020, she received an honorable mention for the Felicia Farr Lemmon Poetry Prize from the Academy of American Poets. She is the assistant poetry editor of Anomaly Journal and a fiction reader for Okay Donkey Magazine, as well as a Tin House and VONA alum. Catch her curled up next to Astrid, her long-haired cat, while endlessly revising her pieces. ">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Datadog take-home assignment" />
<meta property="og:description" content="Exercise 1: Collecting Metrics Postgres conf.yaml: init_config: instances: ## @param host - string - required ## The hostname to connect to. ## NOTE: Even if the server name is &#34;localhost&#34;, the agent connects to ## PostgreSQL using TCP/IP, unless you also provide a value for the sock key. # - host: localhost ## @param port - integer - required ## Port to use when connecting to PostgreSQL. # port: 5432 ## @param user - string - required ## Datadog Username created to connect to PostgreSQL." />
<meta property="og:type" content="article" />
<meta property="og:url" content="//www.lrenazhou.com/datadog/" /><meta property="article:section" content="" />
<meta property="article:published_time" content="2021-02-16T12:08:55-08:00" />
<meta property="article:modified_time" content="2021-02-16T12:08:55-08:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Datadog take-home assignment"/>
<meta name="twitter:description" content="Exercise 1: Collecting Metrics Postgres conf.yaml: init_config: instances: ## @param host - string - required ## The hostname to connect to. ## NOTE: Even if the server name is &#34;localhost&#34;, the agent connects to ## PostgreSQL using TCP/IP, unless you also provide a value for the sock key. # - host: localhost ## @param port - integer - required ## Port to use when connecting to PostgreSQL. # port: 5432 ## @param user - string - required ## Datadog Username created to connect to PostgreSQL."/>

  
  
    
  
  
  <link rel="stylesheet" href="//www.lrenazhou.com/css/style-white.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="//www.lrenazhou.com/images/lemon.png" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="//www.lrenazhou.com/">
  
    <div id="logo" style="background-image: url(//www.lrenazhou.com/images/author_icon.png)"></div>
  
  <div id="title">
    <h1>lrenazhou</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
      
        <li><a href="/">About</a></li>
      
        <li><a href="/writing/">Writing &#43; Honors</a></li>
      
        <li><a href="/experience/">Experience</a></li>
      
        <li><a href="/etc/">&amp;Etc</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="https://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <h2 id="exercise-1-collecting-metrics">Exercise 1: Collecting Metrics</h2>
<ol>
<li><img src="/images/1_1_hostmap_tags.png" alt="Host Map with tags"></li>
<li>Postgres <code>conf.yaml</code>:</li>
</ol>
<pre tabindex="0"><code>init_config:

instances:
  ## @param host - string - required
  ## The hostname to connect to.
  ## NOTE: Even if the server name is &#34;localhost&#34;, the agent connects to
  ## PostgreSQL using TCP/IP, unless you also provide a value for the sock key.
  #
  - host: localhost

    ## @param port - integer - required
    ## Port to use when connecting to PostgreSQL.
    #
    port: 5432

    ## @param user - string - required
    ## Datadog Username created to connect to PostgreSQL.
    #
    username: datadog

    ## @param pass - string - required
    ## Password associated with the Datadog user.
    #
    password: &#34;datadogcandidate&#34;

    ## @param dbname - string - optional - default: postgres
    ## Name of the PostgresSQL database to monitor.
    ## Note: If omitted, the default system postgres database is queried.
    #
    # dbname: &#34;&lt;DB_NAME&gt;&#34;

    # @param disable_generic_tags - boolean - optional - default: false
    # The integration will stop sending server tag as is reduntant with host tag
    disable_generic_tags: true
</code></pre><p>Postgres integration dashboard:
<img src="/images/1_2_postgres_integration_dashboard.png" alt="Postgres integration dashboard"></p>
<ol start="3">
<li><code>custom_my_metric.yaml</code>:</li>
</ol>
<pre tabindex="0"><code>init_config:

instances:
  - min_collection_interval: 45
</code></pre><p><code>custom_my_metric.py</code>:</p>
<pre tabindex="0"><code>import random 

# the following try/except block will make the custom check compatible with any Agent version
try:
    # first, try to import the base class from new versions of the Agent...
    from datadog_checks.base import AgentCheck
except ImportError:
    # ...if the above failed, the check is running in Agent version &lt; 6.6.0
    from checks import AgentCheck

# content of the special variable __version__ will be shown in the Agent status page
__version__ = &#34;1.0.0&#34;

class CustomMyMetricCheck(AgentCheck):
    def check(self, instance):
        random_num = random.randint(0,1000)
        self.gauge(&#39;my_metric&#39;, random_num)
</code></pre><ol start="4">
<li><img src="/images/1_4_my_metric_interval_change.png" alt="my_metric interval change"></li>
<li>You modify the <code>min_collection_interval</code> parameter in the Agent check YAML file.</li>
</ol>
<h2 id="exercise-2-visualizing-data">Exercise 2: Visualizing Data</h2>
<ol>
<li>I used Postman to create a new dashboard using the following curl request:</li>
</ol>
<pre tabindex="0"><code>curl --location &#39;https://us5.datadoghq.com/api/v1/dashboard&#39; \
--header &#39;Content-Type: application/json&#39; \
--header &#39;Accept: application/json&#39; \ 
--header &#39;api_key: &lt;DATADOG API KEY&gt;&#39; \
--header &#39;application_key: &lt;DATADOG APPLICATION KEY&gt;&#39; \
--data &#39;{
  &#34;title&#34;: &#34;Lucy&#39;\&#39;&#39;s metrics dashboard&#34;,
  &#34;widgets&#34;: [
        {
          &#34;definition&#34;: {
                &#34;title&#34;: &#34;my_metric&#34;, 
                &#34;title_size&#34;: &#34;16&#34;, 
                &#34;title_align&#34;: &#34;left&#34;,
                &#34;type&#34;: &#34;timeseries&#34;,
                &#34;requests&#34;: [
                  {
                        &#34;q&#34;: &#34;my_metric{host:docker-desktop}&#34;
                  }
                ]
            }
          },
          {
            &#34;definition&#34;: {
            &#34;title&#34;: &#34;Anomalous Postgres commits&#34;, 
            &#34;title_size&#34;: &#34;16&#34;, 
            &#34;title_align&#34;: &#34;left&#34;,   
            &#34;type&#34;: &#34;timeseries&#34;,
            &#34;requests&#34;: [
                {
                    &#34;q&#34;: &#34;anomalies(postgresql.commits{host:Lucys-MBP}, &#39;\&#39;&#39;basic&#39;\&#39;&#39;, 2)&#34;
                }
              ]
            }
         }
  ],
  &#34;layout_type&#34;: &#34;ordered&#34;
}&#39;
</code></pre><p>Shared dashboard URL: <a href="https://p.us5.datadoghq.com/sb/f4085cf8-fec9-11ed-967f-da7ad0900005-15f84545fbc0e1fd439335dc763d1b85">https://p.us5.datadoghq.com/sb/f4085cf8-fec9-11ed-967f-da7ad0900005-15f84545fbc0e1fd439335dc763d1b85</a></p>
<ol start="2">
<li><img src="/images/2_2_past_5_min.png" alt="Past 5 min dashboard"></li>
<li><img src="/images/2_3_send_snapshot.png" alt="Send snapshot"></li>
<li>The Anomaly graph displays a gray band that shows the expected behavior of the number of transactions that have been committed in the Postgres database, with anomalies, or points with a standard deviation of 2 or greater, highlighted in red.</li>
</ol>
<h2 id="exercise-3-getting-started-with-dogpush">Exercise 3: Getting started with DogPush</h2>
<p><a href="https://github.com/trueaccord/DogPush">DogPush</a> is a Python library that enables you to manage Datadog monitors through YAML files. With DogPush, you can use source control to track and review changes to your monitors, notify your teams, and mute monitors within set time frames, such as outside of business hours.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>Before installing DogPush:</p>
<ul>
<li>Install the <a href="https://docs.datadoghq.com/getting_started/agent/">Datadog Agent</a>.</li>
<li>Install <a href="https://www.python.org/downloads/">Python</a> 3.7+.</li>
<li>Generate valid Datadog API and Application keys. Find your keys under <a href="https://app.datadoghq.com/account/settings#api">Datadog API Settings</a>.</li>
</ul>
<h3 id="install">Install</h3>
<p>Install DogPush using one of two methods:</p>
<ul>
<li><a href="#pip">pip</a></li>
<li><a href="#docker">Docker</a></li>
</ul>
<h4 id="pip">pip</h4>
<p>Before installing DogPush, install and run the latest version of <a href="https://pip.pypa.io/en/stable/cli/pip_install/">pip</a>:</p>
<pre tabindex="0"><code>pip install --upgrade pip
</code></pre><p>Then, install DogPush using pip:</p>
<pre tabindex="0"><code>pip install dogpush
</code></pre><h4 id="docker">Docker</h4>
<p>To install DogPush using <a href="https://docs.docker.com/get-docker/">Docker</a>, pull the DogPush Docker image:</p>
<pre tabindex="0"><code>docker pull trueaccord/dogpush
</code></pre><p><strong>Note:</strong> The DogPush image is only compatible with AMD64 or Intel 64-bit architecture.</p>
<p>Skip ahead to the next section to create the <code>config.yaml</code> file. Then, run <code>docker run</code> and pass in the following arguments:</p>
<ul>
<li>The path of the <code>config</code> directory that contains your configuration YAML files.</li>
<li>The path of <code>config.yaml</code>.</li>
</ul>
<p>This ensures that the Docker container can access the configuration YAML files.</p>
<pre tabindex="0"><code>docker run --rm -v /path/to/config:/config trueaccord/dogpush -c /config/config.yaml diff
</code></pre><h3 id="setup">Setup</h3>
<p>DogPush manages your Datadog monitors through configuration YAML files:</p>
<ul>
<li><code>config.yaml</code>: defines your Datadog API and Application keys, teams, mute tags, and references your <code>rule_files</code> YAML files.</li>
<li><code>rule_files</code> YAML files: configure your monitor alerts.</li>
</ul>
<p>To set up DogPush:</p>
<ol>
<li><a href="#1-create-configyaml">Create <code>config.yaml</code></a>.</li>
<li><a href="#2-add-rule_files-yaml-file-to-configyaml">Add <code>rule_files</code> YAML file to <code>config.yaml</code></a>.</li>
<li><a href="#3-define-teams-for-notifications">Define teams for notifications</a>.</li>
<li><a href="#optional-create-mute-tags"><strong>Optional:</strong> Create mute tags</a>.</li>
</ol>
<h4 id="1-create-configyaml">1. Create <code>config.yaml</code></h4>
<p>a. Create a new directory <code>config</code> that stores your configuration YAML files:</p>
<pre tabindex="0"><code>mkdir config
</code></pre><p>b. In the new <code>config</code> directory, create the <code>config.yaml</code> file using your favorite text editor. Add your Datadog API and Application keys.</p>
<pre tabindex="0"><code>---
datadog:
  api_key: &lt;YOUR_API_KEY&gt;
  app_key: &lt;YOUR_APP_KEY&gt;
</code></pre><p><strong>Note:</strong> If you don’t define your Datadog API and Application keys in <code>config.yaml</code>, DogPush also looks for the environmental variables <code>DATADOG_API_KEY</code> and <code>DATADOG_APP_KEY</code>.</p>
<p>c. Run <code>dogpush diff</code> and pass in your new <code>config.yaml</code> as an argument:</p>
<pre tabindex="0"><code>dogpush -c ./config.yaml diff
</code></pre><p><code>dogpush diff</code> prints untracked changes across your local <code>config.yaml</code> file and remote Datadog monitors. Because <code>config.yaml</code> only contains information about your Datadog API and Application keys, all your monitor alerts should appear as untracked in your terminal.</p>
<p>Now that you have printed your monitor alerts in your local environment, let’s store them in a new <code>rule_files</code> YAML file, <code>my_monitors.yaml</code>.</p>
<h4 id="2-add-rule_files-yaml-file-to-configyaml">2. Add <code>rule_files</code> YAML file to <code>config.yaml</code></h4>
<p>a. In the <code>config</code> directory, run <code>dogpush init</code> to create a new YAML file, <code>my_monitors.yaml</code>, that stores the untracked monitor alerts you printed in the last step.</p>
<pre tabindex="0"><code>dogpush -c ./config.yaml init &gt; ./my_monitors.yaml
</code></pre><p>b. Add <code>my_monitors.yaml</code> as a new <code>rule_files</code> entry to <code>config.yaml</code>. The <code>rule_files</code> entry lists the configuration YAML files that locally store and configure your monitor alerts.</p>
<pre tabindex="0"><code>---
datadog:
  api_key: YOUR_API_KEY
  app_key: YOUR_APP_KEY

rule_files:
  my_monitors.yaml
</code></pre><p>c. Run <code>dogpush diff</code> again. It should not print any untracked changes. Your monitor alerts are now in sync across your local <code>config.yaml</code> and remote Datadog monitors.</p>
<p>Organize your monitor alerts by creating a separate configuration YAML file for each type of alert. Just add the YAML files to the <code>rule_files</code> entry in <code>config.yaml</code>.</p>
<p><strong>Note:</strong> <code>rule_files</code> YAML paths can be relative, absolute, and contain wildcards.</p>
<pre tabindex="0"><code>rule_files:
- rds.yaml
- ec2.yaml
- dir1/rules.yaml
/absolute/path/to/rules.yaml
path/with/wildcard/*.yaml
</code></pre><h4 id="3-define-teams-for-notifications">3. Define teams for notifications</h4>
<p>Define teams to notify the right people about monitor issues.</p>
<p>To define teams:</p>
<p>a. In your <code>config.yaml</code> file, create a new <code>teams</code> entry for <code>eng</code>. For each monitor severity level, use the <code>@</code> notation to specify the team(s) that should be notified in the message body of the monitor. Below is an example <code>teams</code> entry:</p>
<pre tabindex="0"><code>teams:
  eng:
	notifications:
  	CRITICAL: &#39;@hipchat-Engineering @victorops-eng&#39;
  	WARNING: &#39;@eng-alerts@example.com&#39;
</code></pre><p>b. Add <code>team: eng</code> to the top of the desired <code>rule_files</code> YAML file(s). This sets <code>eng</code> as the default team for the monitor alerts defined in the YAML file(s).</p>
<ul>
<li>For <code>CRITICAL</code> alerts, <code>@hipchat-Engineering @victorops-eng</code> are added to the message body of the monitor.</li>
<li>For <code>WARNING</code> alerts, <code>@eng-alerts@example.com</code> is added to the message body of the monitor.</li>
</ul>
<p>c. Add another <code>teams</code> entry for <code>ops</code>:</p>
<pre tabindex="0"><code>ops:
    notifications:
      CRITICAL: &#39;@hipchat-Ops&#39;
</code></pre><p>d. To define both <code>eng</code> and <code>ops</code> as the default teams for a set of monitor alerts, add the following to the desired <code>rule_files</code> YAML file(s):</p>
<pre tabindex="0"><code>team: [eng, ops]
</code></pre><p>e. If you want don’t want a monitor to be associated with a team, set <code>team</code> to an empty array:</p>
<pre tabindex="0"><code>team: []
</code></pre><p>For more information about notifying your teams, see <a href="https://docs.datadoghq.com/monitors/notify/">Notifications</a>.</p>
<h4 id="optional-create-mute-tags">Optional: Create mute tags</h4>
<p>Create mute tags to mute monitors within set time frames. Each mute tag is defined by the following:</p>
<ul>
<li><code>timezone</code>: localizes the time frame to a specific <a href="https://docs.python.org/2/library/datetime.html#datetime.datetime.now">timezone</a>.</li>
<li><code>expr</code>: sets the time frame as a Python expression.</li>
</ul>
<p>In this section, we will walk you through how to set up a mute tag that mutes your monitors outside of business hours in US Pacific Time (PST), which we define as before 9 am and after 5 pm on the weekends.</p>
<p>To create a mute tag:</p>
<ol>
<li>In <code>config.yaml</code>, add <code>not_business_hours</code> to the <code>mute_tags</code> entry:</li>
</ol>
<ul>
<li>Set the <code>timezone</code> to <code>US/Pacific</code>.</li>
<li>Set the <code>expr</code> to <code>now.hour &lt; 9 or now.hour &gt;= 17 or (now.weekday() in (5, 6))</code>, where <a href="https://docs.python.org/2/library/datetime.html#datetime.datetime.now">now</a> represents the local date and time in the timezone you set.</li>
</ul>
<pre tabindex="0"><code>mute_tags:
  not_business_hours:
	timezone: US/Pacific
	expr: now.hour &lt; 9 or now.hour &gt;= 17 or (now.weekday() in (5, 6))
</code></pre><p><strong>Note:</strong> Regardless of your system’s default timezone, DogPush performs its internal time calculations in UTC.</p>
<ol start="2">
<li>After saving <code>config.yaml</code>, add <code>mute_when: not_business_hours</code> to the desired <code>rule_files</code> YAML file(s). As a result, DogPush only mutes monitors with the mute tag <code>not_business_hours</code> applied.</li>
<li>Run <code>dogpush mute</code> to mute monitors. After the mute tag’s time frame expires, monitors are automatically unmuted. To repeatedly mute monitors at a specific time, run <code>dogpush mute</code> from a cron job.</li>
</ol>
<h3 id="further-reading">Further reading</h3>
<p>For further reading, see the following resources:</p>
<ul>
<li><a href="https://github.com/trueaccord/DogPush/blob/master/README.md">DogPush README</a></li>
<li><a href="https://docs.datadoghq.com/getting_started/monitors/">Getting Started with Monitors</a></li>
<li><a href="https://docs.datadoghq.com/monitors/">Alerting</a></li>
</ul>

  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2023  Lucy Zhou 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <li>Theme by <a href="https://github.com/monkeyWzr">monkeyWzr</a> from <a href="https://gohugo.io/">Hugo</a></li>
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
